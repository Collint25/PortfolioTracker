{% extends "base.html" %}

{% block content %}
<div class="mb-4">
    <a href="/linked-trades/" class="btn btn-ghost btn-sm">‚Üê Back to Linked Trades</a>
</div>

<div class="flex justify-between items-start mb-6">
    <div>
        <h1 class="text-3xl font-bold">{{ linked_trade.underlying_symbol }}</h1>
        <p class="text-lg text-base-content/70">
            ${{ "%.2f"|format(linked_trade.strike_price) }}
            {{ linked_trade.option_type }}
            exp {{ linked_trade.expiration_date.strftime('%m/%d/%Y') }}
        </p>
    </div>
    <div class="flex gap-2">
        <span class="badge badge-lg {% if linked_trade.direction == 'LONG' %}badge-info{% else %}badge-warning{% endif %}">
            {{ linked_trade.direction }}
        </span>
        {% if linked_trade.is_closed %}
        <span class="badge badge-lg badge-success">Closed</span>
        {% else %}
        <span class="badge badge-lg badge-outline">Open</span>
        {% endif %}
    </div>
</div>

<!-- P/L Summary -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="stat bg-base-100 shadow rounded-lg">
        <div class="stat-title">Opened</div>
        <div class="stat-value text-lg">{{ linked_trade.total_opened_quantity|int }}</div>
        <div class="stat-desc">contracts</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-lg">
        <div class="stat-title">Closed</div>
        <div class="stat-value text-lg">{{ linked_trade.total_closed_quantity|int }}</div>
        <div class="stat-desc">contracts</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-lg">
        <div class="stat-title">Remaining</div>
        <div class="stat-value text-lg">{{ linked_trade.remaining_quantity|int }}</div>
        <div class="stat-desc">contracts</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-lg">
        <div class="stat-title">Realized P/L</div>
        <div class="stat-value text-lg {% if linked_trade.realized_pl >= 0 %}text-success{% else %}text-error{% endif %}">
            ${{ "%.2f"|format(linked_trade.realized_pl) }}
        </div>
    </div>
</div>

<!-- Legs Table -->
<div class="card bg-base-100 shadow mb-6">
    <div class="card-body">
        <h2 class="card-title">Trade Legs</h2>
        <div class="overflow-x-auto">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Action</th>
                        <th class="text-right">Qty</th>
                        <th class="text-right">Price</th>
                        <th class="text-right">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leg in linked_trade.legs %}
                    <tr class="hover">
                        <td>{{ leg.trade_date.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <span class="badge badge-sm {% if leg.leg_type == 'OPEN' %}badge-primary{% else %}badge-secondary{% endif %}">
                                {{ leg.leg_type }}
                            </span>
                        </td>
                        <td>
                            {% if leg.transaction %}
                            {{ leg.transaction.option_action|replace('_', ' ') if leg.transaction.option_action else leg.transaction.type }}
                            {% endif %}
                        </td>
                        <td class="text-right font-mono">{{ leg.allocated_quantity|int }}</td>
                        <td class="text-right font-mono">${{ "%.2f"|format(leg.price_per_contract) }}</td>
                        <td class="text-right font-mono {% if leg.transaction and leg.transaction.amount >= 0 %}text-success{% else %}text-error{% endif %}">
                            {% if leg.transaction %}
                            ${{ "%.2f"|format(leg.transaction.amount) }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="font-bold">
                        <td colspan="5" class="text-right">Total P/L:</td>
                        <td class="text-right font-mono {% if linked_trade.realized_pl >= 0 %}text-success{% else %}text-error{% endif %}">
                            ${{ "%.2f"|format(linked_trade.realized_pl) }}
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Notes -->
{% if linked_trade.notes %}
<div class="card bg-base-100 shadow mb-6">
    <div class="card-body">
        <h2 class="card-title">Notes</h2>
        <p>{{ linked_trade.notes }}</p>
    </div>
</div>
{% endif %}

<!-- Metadata -->
<div class="card bg-base-100 shadow">
    <div class="card-body">
        <h2 class="card-title text-sm">Details</h2>
        <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="text-base-content/60">Account:</div>
            <div>{{ linked_trade.account.name }}</div>
            <div class="text-base-content/60">Auto-matched:</div>
            <div>{{ "Yes" if linked_trade.is_auto_matched else "No" }}</div>
            <div class="text-base-content/60">Created:</div>
            <div>{{ linked_trade.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
        </div>
    </div>
</div>
{% endblock %}
