<div class="overflow-x-auto">
    <table class="table table-zebra table-sm">
        <thead>
            <tr>
                <th>
                    <a
                        href="?sort_by=trade_date&sort_dir={{ 'asc' if current_sort_by == 'trade_date' and current_sort_dir == 'desc' else 'desc' }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
                        hx-get="/transactions?sort_by=trade_date&sort_dir={{ 'asc' if current_sort_by == 'trade_date' and current_sort_dir == 'desc' else 'desc' }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
                        hx-target="#transaction-table"
                        hx-push-url="true"
                        class="link link-hover"
                    >
                        Date
                        {% if current_sort_by == 'trade_date' %}
                            {{ '↓' if current_sort_dir == 'desc' else '↑' }}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a
                        href="?sort_by=symbol&sort_dir={{ 'asc' if current_sort_by == 'symbol' and current_sort_dir == 'desc' else 'desc' }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
                        hx-get="/transactions?sort_by=symbol&sort_dir={{ 'asc' if current_sort_by == 'symbol' and current_sort_dir == 'desc' else 'desc' }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
                        hx-target="#transaction-table"
                        hx-push-url="true"
                        class="link link-hover"
                    >
                        Symbol
                        {% if current_sort_by == 'symbol' %}
                            {{ '↓' if current_sort_dir == 'desc' else '↑' }}
                        {% endif %}
                    </a>
                </th>
                <th>Type</th>
                <th>Qty</th>
                <th>Price</th>
                <th>
                    <a
                        href="?sort_by=amount&sort_dir={{ 'asc' if current_sort_by == 'amount' and current_sort_dir == 'desc' else 'desc' }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
                        hx-get="/transactions?sort_by=amount&sort_dir={{ 'asc' if current_sort_by == 'amount' and current_sort_dir == 'desc' else 'desc' }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
                        hx-target="#transaction-table"
                        hx-push-url="true"
                        class="link link-hover"
                    >
                        Amount
                        {% if current_sort_by == 'amount' %}
                            {{ '↓' if current_sort_dir == 'desc' else '↑' }}
                        {% endif %}
                    </a>
                </th>
                <th>Account</th>
            </tr>
        </thead>
        <tbody>
            {% for txn in transactions %}
            <tr
                class="hover cursor-pointer"
                hx-get="/transactions/{{ txn.id }}"
                hx-push-url="true"
                hx-target="body"
            >
                <td>{{ txn.trade_date.strftime('%Y-%m-%d') if txn.trade_date else 'N/A' }}</td>
                <td class="font-mono font-semibold">
                    {{ txn.underlying_symbol if txn.is_option else txn.symbol or '-' }}
                    {% if txn.is_option %}
                    <span class="text-xs text-base-content/60 font-normal ml-1">
                        ${{ '{:.0f}'.format(txn.strike_price) if txn.strike_price else '?' }}
                        {{ txn.expiration_date.strftime('%m/%d') if txn.expiration_date else '' }}
                        <span class="{{ 'text-success' if txn.option_type == 'CALL' else 'text-error' if txn.option_type == 'PUT' else '' }}">
                            {{ 'C' if txn.option_type == 'CALL' else 'P' if txn.option_type == 'PUT' else '' }}
                        </span>
                    </span>
                    {% endif %}
                </td>
                <td>
                    {% if txn.is_option and txn.option_action %}
                    <span class="badge badge-sm {{ 'badge-success' if 'BUY' in txn.option_action else 'badge-error' if 'SELL' in txn.option_action else 'badge-info' }}">
                        {{ txn.option_action.replace('_', ' ') }}
                    </span>
                    {% else %}
                    <span class="badge badge-sm {{ 'badge-success' if txn.type == 'BUY' else 'badge-error' if txn.type == 'SELL' else 'badge-info' }}">
                        {{ txn.type }}
                    </span>
                    {% endif %}
                </td>
                <td class="text-right">{{ '{:,.2f}'.format(txn.quantity) if txn.quantity else '-' }}</td>
                <td class="text-right">${{ '{:,.2f}'.format(txn.price) if txn.price else '-' }}</td>
                <td class="text-right {{ 'text-success' if txn.amount > 0 else 'text-error' if txn.amount < 0 else '' }}">
                    ${{ '{:,.2f}'.format(txn.amount) }}
                </td>
                <td class="text-sm text-base-content/70">{{ txn.account.name if txn.account else 'N/A' }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center py-8 text-base-content/50">
                    No transactions found
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="flex justify-center mt-4">
    <div class="join">
        {% if page > 1 %}
        <a
            href="?page={{ page - 1 }}&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
            hx-get="/transactions?page={{ page - 1 }}&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
            hx-target="#transaction-table"
            hx-push-url="true"
            class="join-item btn btn-sm"
        >«</a>
        {% endif %}

        <span class="join-item btn btn-sm btn-disabled">
            Page {{ page }} of {{ total_pages }}
        </span>

        {% if page < total_pages %}
        <a
            href="?page={{ page + 1 }}&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
            hx-get="/transactions?page={{ page + 1 }}&sort_by={{ current_sort_by }}&sort_dir={{ current_sort_dir }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}"
            hx-target="#transaction-table"
            hx-push-url="true"
            class="join-item btn btn-sm"
        >»</a>
        {% endif %}
    </div>
</div>
{% endif %}

{% if is_htmx %}
<!-- OOB swaps: Update save filter UI when filters change -->
{% with oob=true %}
{% include "partials/save_filter_button.html" %}
{% endwith %}
<input type="hidden" id="save-filter-query-string" name="query_string" value="{{ filter_query_string }}" hx-swap-oob="outerHTML" />
<!-- OOB: Update saved filters list to highlight active filter -->
<div id="saved-filters" hx-swap-oob="innerHTML">
{% set filter_page = "transactions" %}
{% include "partials/saved_filter_list.html" %}
</div>
{% endif %}
