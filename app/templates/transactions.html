{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Transactions</h1>
    <span class="badge badge-lg">{{ total }} total</span>
</div>

<!-- Saved Filters -->
<div class="flex flex-wrap items-center gap-3 mb-4">
    <span class="text-sm font-medium">Saved:</span>
    <div id="saved-filters">
        {% set filter_page = "transactions" %}
        {% include "partials/saved_filter_list.html" %}
    </div>
    {% include "partials/save_filter_button.html" %}
</div>

<!-- Save Filter Modal -->
<dialog id="save-filter-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Save Current Filters</h3>
        <form
            hx-post="/saved-filters/transactions"
            hx-target="#saved-filters"
            hx-swap="innerHTML"
            class="mt-4"
        >
            <input type="hidden" id="save-filter-query-string" name="query_string" value="{{ filter_query_string }}" />
            <div class="form-control">
                <label class="label"><span class="label-text">Filter Name</span></label>
                <input type="text" name="name" class="input input-bordered" placeholder="e.g., Options Only" required />
            </div>
            <div class="form-control mt-2">
                <label class="label cursor-pointer justify-start gap-2">
                    <input type="checkbox" name="is_favorite" value="true" class="checkbox checkbox-sm" />
                    <span class="label-text">Set as favorite (auto-apply on page load)</span>
                </label>
            </div>
            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('save-filter-modal').close()">Cancel</button>
                <button type="submit" class="btn btn-primary" onclick="document.getElementById('save-filter-modal').close()">Save</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Filters -->
<div class="card bg-base-100 shadow mb-6">
    <div class="card-body py-4">
        <form
            id="filter-form"
            hx-get="/transactions"
            hx-target="#transaction-table"
            hx-trigger="filterChanged from:body"
            hx-push-url="true"
            hx-indicator="#table-loading"
        >
            <!-- Row 1: Primary Filters -->
            <div class="flex flex-wrap gap-3 items-end mb-3">
                <!-- Search -->
                <div class="form-control w-48">
                    <label class="label py-1"><span class="label-text text-xs">Search</span></label>
                    <input
                        type="text"
                        name="search"
                        value="{{ current_search or '' }}"
                        placeholder="Symbol or description"
                        class="input input-bordered input-sm"
                        oninput="debouncedFilterChange()"
                    />
                </div>

                <!-- Symbol (chip multi-select with autocomplete) -->
                {% from "macros/chip_multiselect.html" import chip_multiselect %}
                {{ chip_multiselect(
                    name="symbol",
                    label="Symbol",
                    values=current_symbols,
                    mode=current_symbol_mode,
                    autocomplete_url="/api/symbols"
                ) }}

                <!-- Type (chip multi-select with dropdown) -->
                {{ chip_multiselect(
                    name="type",
                    label="Type",
                    values=current_types,
                    mode=current_type_mode,
                    options=types
                ) }}

                <!-- Account (single select) -->
                <div class="form-control w-40">
                    <label class="label py-1"><span class="label-text text-xs">Account</span></label>
                    <select name="account_id" class="select select-bordered select-sm" onchange="dispatchFilterChanged()">
                        <option value="">All</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}" {{ 'selected' if current_account_id == account.id else '' }}>
                            {{ account.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Row 2: Refinement Filters -->
            <div class="flex flex-wrap gap-3 items-end pt-3 border-t border-base-200">
                <!-- Date Range -->
                <div class="form-control w-36">
                    <label class="label py-1"><span class="label-text text-xs">From</span></label>
                    <input
                        type="date"
                        name="start_date"
                        value="{{ current_start_date or '' }}"
                        class="input input-bordered input-sm"
                        onchange="dispatchFilterChanged()"
                    />
                </div>

                <div class="form-control w-36">
                    <label class="label py-1"><span class="label-text text-xs">To</span></label>
                    <input
                        type="date"
                        name="end_date"
                        value="{{ current_end_date or '' }}"
                        class="input input-bordered input-sm"
                        onchange="dispatchFilterChanged()"
                    />
                </div>

                <!-- Options Group -->
                <div class="flex items-end gap-2 px-3 py-2 bg-base-200 rounded-lg">
                    <span class="text-xs text-base-content/70 font-medium self-center">Options:</span>

                    <div class="form-control w-28">
                        <select name="is_option" class="select select-bordered select-sm" onchange="dispatchFilterChanged()">
                            <option value="">All</option>
                            <option value="true" {{ 'selected' if current_is_option == 'true' else '' }}>Options</option>
                            <option value="false" {{ 'selected' if current_is_option == 'false' else '' }}>Stocks</option>
                        </select>
                    </div>

                    <div class="form-control w-24">
                        <select name="option_type" class="select select-bordered select-sm" onchange="dispatchFilterChanged()">
                            <option value="">C/P</option>
                            {% for ot in option_types %}
                            <option value="{{ ot }}" {{ 'selected' if current_option_type == ot else '' }}>{{ ot }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-control w-36">
                        <select name="option_action" class="select select-bordered select-sm" onchange="dispatchFilterChanged()">
                            <option value="">Action</option>
                            {% for oa in option_actions %}
                            <option value="{{ oa }}" {{ 'selected' if current_option_action == oa else '' }}>{{ oa.replace('_', ' ') }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Tag (chip multi-select) -->
                {% set tag_options = [] %}
                {% for tag in tags %}
                    {% set _ = tag_options.append({'value': tag.id|string, 'label': tag.name}) %}
                {% endfor %}
                {{ chip_multiselect(
                    name="tag_id",
                    label="Tag",
                    values=current_tag_ids|map('string')|list,
                    mode=current_tag_mode,
                    options=tag_options
                ) }}

                <!-- Clear Filters -->
                <a href="/transactions" class="btn btn-ghost btn-sm text-error ml-auto">Clear All</a>
            </div>

            <!-- Hidden sort fields -->
            <input type="hidden" name="sort_by" value="{{ current_sort_by }}" />
            <input type="hidden" name="sort_dir" value="{{ current_sort_dir }}" />
        </form>
    </div>
</div>

<!-- Loading indicator -->
<div id="table-loading" class="htmx-indicator flex justify-center py-4">
    <span class="loading loading-spinner loading-md"></span>
</div>

<!-- Transaction table -->
<div id="transaction-table">
    {% include "partials/transaction_table.html" %}
</div>
{% endblock %}
