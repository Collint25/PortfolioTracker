{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Transactions</h1>
    <span class="badge badge-lg">{{ total }} total</span>
</div>

<!-- Saved Filters -->
<div class="flex flex-wrap items-center gap-3 mb-4">
    <span class="text-sm font-medium">Saved:</span>
    <div id="saved-filters">
        {% set filter_page = "transactions" %}
        {% include "partials/saved_filter_list.html" %}
    </div>
    {% if filter_query_string %}
    <button
        class="btn btn-ghost btn-xs"
        onclick="document.getElementById('save-filter-modal').showModal()"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Save Current
    </button>
    {% endif %}
    {% if applied_favorite %}
    <div class="badge badge-info gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
        </svg>
        <span>Using: {{ applied_favorite.name }}</span>
        <a href="/transactions" class="hover:text-info-content">&times;</a>
    </div>
    {% endif %}
</div>

<!-- Save Filter Modal -->
<dialog id="save-filter-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Save Current Filters</h3>
        <form
            hx-post="/saved-filters/transactions"
            hx-target="#saved-filters"
            hx-swap="innerHTML"
            class="mt-4"
        >
            <input type="hidden" name="query_string" value="{{ filter_query_string }}" />
            <div class="form-control">
                <label class="label"><span class="label-text">Filter Name</span></label>
                <input type="text" name="name" class="input input-bordered" placeholder="e.g., Options Only" required />
            </div>
            <div class="form-control mt-2">
                <label class="label cursor-pointer justify-start gap-2">
                    <input type="checkbox" name="is_favorite" value="true" class="checkbox checkbox-sm" />
                    <span class="label-text">Set as favorite (auto-apply on page load)</span>
                </label>
            </div>
            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('save-filter-modal').close()">Cancel</button>
                <button type="submit" class="btn btn-primary" onclick="document.getElementById('save-filter-modal').close()">Save</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Filters -->
<div class="card bg-base-100 shadow mb-6">
    <div class="card-body py-4">
        <form
            id="filter-form"
            hx-get="/transactions"
            hx-target="#transaction-table"
            hx-trigger="submit, change from:select"
            hx-push-url="true"
        >
            <!-- Primary Filters Row -->
            <div class="flex flex-wrap gap-3 items-end">
                <!-- Search -->
                <div class="form-control w-48">
                    <label class="label py-1"><span class="label-text text-xs">Search</span></label>
                    <input
                        type="text"
                        name="search"
                        value="{{ current_search or '' }}"
                        placeholder="Symbol or description"
                        class="input input-bordered input-sm"
                    />
                </div>

                <!-- Account -->
                <div class="form-control w-40">
                    <label class="label py-1"><span class="label-text text-xs">Account</span></label>
                    <select name="account_id" class="select select-bordered select-sm">
                        <option value="">All</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}" {{ 'selected' if current_account_id == account.id else '' }}>
                            {{ account.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Symbol -->
                <div class="form-control w-32">
                    <label class="label py-1"><span class="label-text text-xs">Symbol</span></label>
                    <select name="symbol" class="select select-bordered select-sm">
                        <option value="">All</option>
                        {% for sym in symbols %}
                        <option value="{{ sym }}" {{ 'selected' if current_symbol == sym else '' }}>{{ sym }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Type -->
                <div class="form-control w-28">
                    <label class="label py-1"><span class="label-text text-xs">Type</span></label>
                    <select name="type" class="select select-bordered select-sm">
                        <option value="">All</option>
                        {% for t in types %}
                        <option value="{{ t }}" {{ 'selected' if current_type == t else '' }}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Date Range -->
                <div class="form-control w-36">
                    <label class="label py-1"><span class="label-text text-xs">From</span></label>
                    <input type="date" name="start_date" value="{{ current_start_date or '' }}" class="input input-bordered input-sm" />
                </div>

                <div class="form-control w-36">
                    <label class="label py-1"><span class="label-text text-xs">To</span></label>
                    <input type="date" name="end_date" value="{{ current_end_date or '' }}" class="input input-bordered input-sm" />
                </div>

                <!-- Apply Button -->
                <button type="submit" class="btn btn-primary btn-sm">Apply</button>

                <!-- Toggle Advanced -->
                <button
                    type="button"
                    class="btn btn-ghost btn-sm"
                    onclick="document.getElementById('advanced-filters').classList.toggle('hidden')"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    More
                </button>
            </div>

            <!-- Advanced Filters (Collapsible) -->
            <div id="advanced-filters" class="{{ '' if current_is_option or current_option_type or current_option_action or current_tag_id else 'hidden' }} mt-4 pt-4 border-t border-base-300">
                <div class="flex flex-wrap gap-3 items-end">
                    <!-- Options Group -->
                    <div class="flex items-end gap-2 px-3 py-2 bg-base-200 rounded-lg">
                        <span class="text-xs text-base-content/70 font-medium self-center">Options:</span>

                        <div class="form-control w-28">
                            <select name="is_option" class="select select-bordered select-sm">
                                <option value="">All</option>
                                <option value="true" {{ 'selected' if current_is_option == 'true' else '' }}>Options</option>
                                <option value="false" {{ 'selected' if current_is_option == 'false' else '' }}>Stocks</option>
                            </select>
                        </div>

                        <div class="form-control w-24">
                            <select name="option_type" class="select select-bordered select-sm">
                                <option value="">C/P</option>
                                {% for ot in option_types %}
                                <option value="{{ ot }}" {{ 'selected' if current_option_type == ot else '' }}>{{ ot }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-control w-36">
                            <select name="option_action" class="select select-bordered select-sm">
                                <option value="">Action</option>
                                {% for oa in option_actions %}
                                <option value="{{ oa }}" {{ 'selected' if current_option_action == oa else '' }}>{{ oa.replace('_', ' ') }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Tag -->
                    <div class="form-control w-32">
                        <label class="label py-1"><span class="label-text text-xs">Tag</span></label>
                        <select name="tag_id" class="select select-bordered select-sm">
                            <option value="">All Tags</option>
                            {% for tag in tags %}
                            <option value="{{ tag.id }}" {{ 'selected' if current_tag_id == tag.id else '' }}>{{ tag.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Clear Filters -->
                    <a href="/transactions" class="btn btn-ghost btn-sm text-error">Clear All</a>
                </div>
            </div>

            <!-- Hidden sort fields -->
            <input type="hidden" name="sort_by" value="{{ current_sort_by }}" />
            <input type="hidden" name="sort_dir" value="{{ current_sort_dir }}" />
        </form>
    </div>
</div>

<!-- Transaction table -->
<div id="transaction-table">
    {% include "partials/transaction_table.html" %}
</div>
{% endblock %}
